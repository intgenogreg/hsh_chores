<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>甜蜜的家值日生</title>
  <style>
    button {
      width: 100px;
      height: 35px;
      font-size: 15px;
      margin-right: 10px;
    }
    p {
      font-size: 20px;
      display: inline-block;
      margin-right: 10px;
    }
    img {
      height: 150px;
      display: block;
      margin-top: 50px;
    }
    table {
      margin-top: 20px;
      border-collapse: collapse;
    }
    th, td {
      padding: 10px;
    }
  </style>
</head>
<body>
  <h1 style="font-size:100px; text-align:center;">甜蜜的家 值日生 <br/> 輪值系統</h1>
  <h3 style="font-size:50px; text-align:center;"><span id="time"></span></h3>
  <h3 style="font-size:50px; text-align:center;">參與者：爸、媽、謙、冠</h3>

  <div style="font-size:40px"><center>
    <table width="1000" style="text-align:center;" border="1">
      <tr>
        <th></th>
        <th>洗衣服</th>
        <th>倒垃圾</th>
        <th>切水果</th>
      </tr>
      <tr style="font-size:50px">
        <td width="75">負責人</td>
        <td><span id="clothes"></span></td>
        <td><span id="garbage"></span></td>
        <td><span id="fruit"></span></td>
      </tr>
    </table>
  </center></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDi9v1HV7UFeQnePmg3ZUYeK3wO9O731GI",
      authDomain: "hsh-chores.firebaseapp.com",
      projectId: "hsh-chores",
      storageBucket: "hsh-chores.firebasestorage.app",
      messagingSenderId: "961868131334",
      appId: "1:961868131334:web:216b9eb86697f5fe162787",
      measurementId: "G-75SKCF41PG"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const people = ["爸", "媽", "謙", "冠"];

    function getFormattedTaiwanTime(date) {
      return date.toLocaleString('zh-TW', {
        timeZone: 'Asia/Taipei',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
      });
    }

    function getTodayKey(date = new Date()) {
      const taiwanDate = new Date(date.toLocaleString("en-US", { timeZone: "Asia/Taipei" }));
      const yyyy = taiwanDate.getFullYear();
      const mm = String(taiwanDate.getMonth() + 1).padStart(2, '0');
      const dd = String(taiwanDate.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function rand() {
      let p = [...people];
      let clo = p.splice(Math.floor(Math.random() * p.length), 1)[0];
      let gar = p.splice(Math.floor(Math.random() * p.length), 1)[0];
      let fru = p.splice(Math.floor(Math.random() * p.length), 1)[0];
      return { clothes: clo, garbage: gar, fruit: fru };
    }

    function updateUI(data) {
      document.getElementById("clothes").textContent = data.clothes;
      document.getElementById("garbage").textContent = data.garbage;
      document.getElementById("fruit").textContent = data.fruit;
    }

    function fetchOrGenerateToday() {
      const now = new Date();
      const formatted = getFormattedTaiwanTime(now);
      document.getElementById("time").textContent = "台灣時間：" + formatted;

      const key = getTodayKey(now);
      const ref = db.ref("chores/" + key);

      ref.once("value").then((snapshot) => {
        if (snapshot.exists()) {
          updateUI(snapshot.val());
        } else {
          const result = rand();
          ref.set(result);
          updateUI(result);
        }
      });
    }

    // 初次載入執行
    fetchOrGenerateToday();
  </script>
</body>
</html>
